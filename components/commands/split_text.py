# Auto generated by LangBot Plugin SDK.
# Please refer to https://docs.langbot.app/en/plugin/dev/tutor.html for more details.
from __future__ import annotations

import logging
from typing import AsyncGenerator

from langbot_plugin.api.definition.components.command.command import Command, Subcommand
from langbot_plugin.api.entities.builtin.command.context import (
    CommandReturn,
    ExecuteContext,
)


class SplitText(Command):
    async def initialize(self) -> None:
        await super().initialize()

        from pkg.state import get_state, uid

        logger = logging.getLogger("split_typing_plugin")

        @self.subcommand(name="on", help="å¼€å¯åˆ†æ®µ", usage="!split_text on", aliases=[])
        async def sendon(
            self, ctx: ExecuteContext
        ) -> AsyncGenerator[CommandReturn, None]:
            chat_type = ctx.session.launcher_type
            chat_id = (
                ctx.session.launcher_id
                if chat_type == "group"
                else ctx.session.sender_id
            )
            if chat_id is None:
                logger.error(f"ğŸ§©SplitTyping {chat_id} ä¸ºç©º")
                return

            get_state().enable(uid(chat_type.value, chat_id))
            logger.info(f"ğŸ§©SplitTyping {chat_id} å·²å¼€å¯åˆ†æ®µå‘é€ã€‚")
            yield CommandReturn(text=f"å·²å¼€å¯åˆ†æ®µå‘é€ã€‚")

        # å…³é—­åˆ†æ®µ
        @self.subcommand(
            name="off", help="å…³é—­åˆ†æ®µ", usage="!split_text off", aliases=[]
        )
        async def sendoff(
            self, ctx: ExecuteContext
        ) -> AsyncGenerator[CommandReturn, None]:
            logger.debug(
                f"ğŸ§©SplitTyping {ctx.session.launcher_type.value}_{ctx.session.launcher_id}_{ctx.session.sender_id}"
            )
            chat_type = ctx.session.launcher_type
            chat_id = (
                ctx.session.launcher_id
                if chat_type == "group"
                else ctx.session.sender_id
            )

            if chat_id is None:
                logger.error(f"ğŸ§©SplitTyping {chat_id} ä¸ºç©º")
                return

            get_state().disable(uid(chat_type.value, chat_id))
            logger.info(f"ğŸ§©SplitTyping {chat_id} å·²å…³é—­åˆ†æ®µå‘é€ã€‚")
            yield CommandReturn(text=f"å·²å…³é—­åˆ†æ®µå‘é€ã€‚")
